#!/usr/bin/python

import glob
import os
from library import *
import sys


def replace_pattern_in_template(template, pattern, str_replace):
    """pattern by galaxy name and returns new string"""
    contents1 = template.replace(pattern, str_replace)
    return contents1


PATH = "./all-fits"

# # Extract all galaxy names
ff = glob.glob(os.path.join(PATH, "psf*.fits"))
galaxy_names = []
for f in ff:
    filename = os.path.basename(f)
    # print filename
    pieces = filename.split("_")
    galaxy_name = pieces[1]
    galaxy_names.append(galaxy_name)


# # Reads some input data
# template 
with open("galfit.feedme.template", "r") as file:
  template = file.read()
# Galaxy table in CSV format
table = load_jma_gri("CALIFA-JMA-gri.mfmtk")


print table[0]

#sys.exit()


# # Runs script for all galaxies
FEEDME_FILENAME = "galfit.feedme"
COMMAND = "./galfitm-1.2.1-linux-x86_64 "+FEEDME_FILENAME
for galaxy_name in galaxy_names:
    filename_test = os.path.join(PATH, galaxy_name+"_g.fits")
    if not os.path.isfile(filename_test):
        print "**WARNING**: file '%s' not found, skipping galaxy '%s' :(" % (filename_test, galaxy_name)
    else:
        width, height = get_dims(filename_test)
    
        
        row = find_row_by_galaxy_name(table, galaxy_name)
        #except:
        #    print "Could not find galaxy '%s' in table" % galaxy_name

        if row:            
            contents = replace_pattern_in_template(template, "@@@@@@", galaxy_name)
            contents = replace_pattern_in_template(contents, "WWWWWW", str(width))
            contents = replace_pattern_in_template(contents, "HHHHHH", str(height))
            contents = replace_pattern_in_template(contents, "XGXGXG", row["x0Fit2D_g"]) 
            contents = replace_pattern_in_template(contents, "XRXRXR", row["x0Fit2D_r"]) 
            contents = replace_pattern_in_template(contents, "XIXIXI", row["x0Fit2D_i"]) 
            contents = replace_pattern_in_template(contents, "YGYGYG", row["y0Fit2D_g"]) 
            contents = replace_pattern_in_template(contents, "YRYRYR", row["y0Fit2D_r"]) 
            contents = replace_pattern_in_template(contents, "YIYIYI", row["y0Fit2D_i"]) 
#        contents = replace_pattern_in_template(contents, "XXXXXX", str(float(width)/2))
#        contents = replace_pattern_in_template(contents, "YYYYYY", str(float(height)/2))
        
            with open(FEEDME_FILENAME, "w") as file:
                file.write(contents)
            os.system(COMMAND)               
#        break


#    pieces = os.path.basename(f)

